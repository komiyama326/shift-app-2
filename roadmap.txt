現在のコードと要件の比較・分析
【実装済み or 実装の基盤が完成している要件】

✅ スタッフ登録（追加・削除）: StaffManager で基盤はOK。GUIで操作できるようにするだけ。

✅ スタッフ毎の色分け: Staff クラスに color_code を持っており、基盤はOK。

✅ スタッフ毎に当直不可能な曜日を設定:

ご指摘ありがとうございます。これは実装済みです！ Staffクラスの impossible_weekdays がこの役割を担っており、スケジューラもこれを考慮しています。ロードマップの記載が不明瞭でした。

✅ 最低限の当直間隔を設定: min_interval として実装済み。

✅ 1日あたりの当直人数を設定（曜日別）: shifts_per_day で実装済み。

✅ 過去の担当回数を参照: previous_counts として実装済み。

✅ 担当回数の平均化（月内＋過去）: バックトラッキングの探索順序で実装済み。

✅ 週末・祝日回数の平均化: previous_holiday_counts とスコアリングで実装済み。

✅ カレンダーと祝日の自動生成: generate_calendar_with_holidays で実装済み。

✅ 特別な理由での休暇設定: vacations として実装済み。

【ロードマップでこれから実装予定だが、より具体化が必要な要件】

🟡 当直固定日の設定: 現在は「特定の日付」でしか指定できない。「第〇何曜日」というルールベースの指定は未実装。

🟡 CSV出力、印刷、デザイン: 【フェーズ4】で予定しているが、3段組レイアウトなど、より具体的な要件を反映させる必要がある。

【現在のロードマップで不足している、または明確に記載されていない要件】

❌ 先月末の担当者との間隔考慮: 先月末の担当者情報を引き継ぎ、月初のシフトが勤務間隔ルールを破らないようにする機能。

❌ 複数解の提示と選択: 解が複数見つかった場合に、それらをユーザーに提示して選ばせる機能。現在のソルバーは最初に見つけた解を返すだけ。

❌ 設定の保存と読込: スタッフ情報や各種ルールをファイルに保存し、次回起動時に読み込む機能。

❌ 「何人から何人」という柔軟な人数設定: 現在は固定人数のみ。

❌ 特定の曜日グループでの公平性: 「土日祝」だけでなく、ユーザーが定義した曜日グループ（例：「水・日・祝」）での公平性を担保する機能。

結論と新たなロードマップの提案

分析の結果、コアエンジンは非常に強力ですが、「ルールの永続化（保存/読込）」と「ルールの更なる柔軟性」、そして**「ユーザーの選択肢」**に関する機能がロードマップに不足していることが明確になりました。

これらの要素を組み込み、ステップ番号を継続させた、最新かつ最終版のロードマップを以下に提示します。

最新・最終版：シフト表自動作成アプリ 開発ロードマップ

【フェーズ0 & 1】エンジン開発（完了）

Step 1-11: 完了済み

【フェーズ2】エンジン機能の拡張と完成（現在のフェーズ）

Step 12: 固定シフト機能の実装（日付指定）

Step 13: 個別休暇設定機能の実装

Step 14: 週末・祝日回数の公平性向上

Step 15: 曜日別担当人数設定機能

Step 16 (New): ルールベース固定シフト機能の実装

「毎月第2火曜日はAさん」のような、ルールベースの固定シフトを設定できる機能を追加します。

Step 17 (New): 月またぎの勤務間隔考慮機能

前月の最終担当者情報を引き継ぎ、月初のシフト作成時に最低勤務間隔を考慮する機能を追加します。

Step 18 (New): 複数解の探索と提示機能

バックトラッキングを改良し、解を一つ見つけて終わるのではなく、指定された数だけ（または時間切れまで）探索を続け、見つかった複数の解をリストとして返せるようにします。

step 18'

step13に第〇何曜日、という形での指定も追加

ここまでの総合テストを実施

【フェーズ3】設定の永続化とGUI基盤構築

Step 19 (New): 設定の保存・読込機能の実装

スタッフ情報、各種ルール（固定、休暇、人数、間隔など）を一つの設定ファイル（JSON形式などが適）に保存し、次回起動時に読み込めるようにします。これはGUIを作る前の最重要ステップです。

Step 20 (旧16): GUI基本骨格の構築

PySide6を導入し、メインウィンドウ、メニューバー、ステータスバーなどを作成します。

step 18''

step13に第〇何曜日、という形での指定を再確認し追加

✅ スタッフ毎に当直不可能な曜日を設定:
-   **Step 21: スタッフ設定UIの実装** (これから着手)
    -   **21-1. UIの拡張**: 前回中断した「スタッフ設定」タブに、**ルールベース不可日**（第〇何曜日が不可）を設定するためのUI部品（チェックボックスやドロップダウンなど）を追加します。
    -   **21-2. UIロジックの実装**: UIと `SettingsManager` を連携させ、スタッフ情報の読み込み、追加、削除、保存を実際に機能させます。
    -   **21-3. (任意) UIの改善**: カラーコード入力欄の横に、カラーピッカーダイアログを開くボタンを追加します。

-   **Step 22: ルール設定UIとエンジン連携**
    -   **22-1. ルール設定UIの作成**: 新しいタブに、ルールベースの**固定シフト**と**休暇**を設定するためのUIを作成します。
    -   **22-2. 基本設定UIの作成**: `min_interval` などの基本パラメータを設定するUIを設けます。
    -  22-3. エンジン連携と結果表示
        22-3-a. UIの骨格作成: ✅ generation_tab.py のレイアウトが完成。
        22-3-b. エンジン呼び出しと非同期処理: ✅ 「生成」ボタンでワーカースレッドが起動し、UIをフリーズさせずに計算を実行できる。
        22-3-c. 結果の表示と選択: ✅ 見つかった複数解をリスト表示し、選択した解をカレンダー形式でプレビュー表示。CSV出力も可能。

【フェーズ4】仕上げとアウトプット
    step23
        目的: ユーザーが「公平」の定義をカスタマイズできるようにし、過去データの入力を効率化する。
        タスク:
        23-1. (New) カスタム公平性グループ設定UI:
            「基本設定」タブなどに、「公平性を考慮する曜日」として、月〜日＋祝日のチェックボックスを設ける。ユーザーはここで「土・日・祝」や「水・日」など、独自のグループを定義できる。
        23-2. (New) コアエンジンの公平性ロジック修正:
            ShiftScheduler が、UIで設定されたカスタム公平性グループを解釈し、その曜日の担当回数を特別にカウントして、ばらつきが少なくなるように探索ロジックを修正する。
        23-3. 過去データ入力UIとロジックの実装:
            「シフト生成」タブの「オプション設定」エリアに、過去の総担当回数と、公平性グループの担当回数を手動で入力できるテーブルUIを実装する。
            (New) シフト履歴の保存・読込機能:
            ユーザーがシフト解を「採用」した際に、そのシフトデータ（誰がいつ担当したか）を、年月がわかるようなファイル名（例: history_2024-08.json）で専用フォルダに保存する機能を追加する。
            シフト生成時に、対象年月の過去2ヶ月分の履歴ファイルが存在するか自動でチェックし、存在すればその内容から過去の担当回数を計算して、UIの入力欄に自動でプリセットする機能を追加する。
        23-4. (New) 月限定・日付指定休暇UIの実装:
            「シフト生成」タブの「オプション設定」エリアに**「月限定の休暇設定」**というセクションを新設します。
            スタッフ名を選択するコンボボックスと、「日付を選択」ボタンを配置します。
            このボタンを押すと、**カレンダーウィジェット（QCalendarWidget）**が表示されるポップアップダイアログが開きます。
            ユーザーはカレンダー上で日付を複数選択できます。
            「OK」を押すと、選択した日付が「スタッフA: 15日, 16日」のようにリスト表示されます。
        23-5. (New) エンジンへの月限定休暇の連携:
            「シフト生成！」ボタンが押された際に、この月限定休暇の情報を ShiftScheduler の solve メソッドに新しい引数（例: manual_vacations）として渡します。
            ソルバーは、この情報を元に、そのスタッフをその日には割り当てないようにします。
        Step 23-6: UIの改善とオプション機能の最終強化
            このステップの目的は、ユーザーの操作性を向上させるためのUI改善と、より現実に即したシフト条件に対応するための柔軟なオプション機能を追加し、アプリケーションの完成度を飛躍的に高めることです。
            Step 23-6-1: 担当者不要日の設定機能
                目的: 月の中で、シフト割り当てが不要な日（例: 特別な休業日）を設定できるようにする。
                UI: 「シフト生成」タブに「担当者不要日」セクションを新設。「日付を選択...」ボタンでカレンダーダイアログを開き、不要日を複数設定できるようにする。
                エンジン: 設定された日付をシフト生成の対象から除外する。
            step 23-6-1.5: オプション設定エリアのUIをタブ形式に改善する
            Step 23-6-2: 月限定の固定シフト設定機能
                目的: ルールとは別に、単発のシフト固定に対応する（例：「今月の10日だけはBさん」）。
                UI: 「シフト生成」タブに「月限定固定シフト」セクションを新設。スタッフを選択し、カレンダーで日付を1日選択してリストに追加する。
                エンジン: ルールベースの固定シフトよりも優先して、この月限定固定シフトを適用する。
            Step 23-6-2.5 (New): 月限定オプションUIの入れ子タブ化
                目的: 縦長になった「月限定」タブ内のUIを、さらにタブで分割し、操作性を向上させる。
                タスク: generation_tab.pyを修正し、「月限定」タブの中に「固定シフト」「休暇」「不要日」の3つのサブタブを作成し、各機能を再配置する。
            Step 23-6-3: 最大連勤日数の設定機能
                目的: スタッフの疲労を考慮し、「最大〇連勤まで」という上限を設定する。
                UI: 「基本設定」タブに「最大連勤日数」のスピンボックスを追加する。
                エンジン: 各スタッフの連勤日数をカウントし、上限を超えないように候補者を選択するロジックを追加する。
            Step 23-6-4: 公平性許容差の設定機能
                目的: ルールが厳しい場合に、ユーザーが公平性の基準を緩めて解を見つけられるようにする。
                UI: 「基本設定」タブに「公平性の許容差（回数差）」のスピンボックスを追加する。
                エンジン: UIから渡された許容差の値を、公平性チェックの際に使用する。
            Step 23-6-5: カラーピッカーダイアログの実装
                目的: スタッフの色分け設定を、カラーコードの手入力だけでなく、直感的なカラーピッカーで行えるようにする。
                UI: 「スタッフ設定」タブのカラーコード入力欄の横に「色を選択」ボタンを追加。ボタンを押すとカラーピッカーダイアログが開き、選択した色が入力欄に反映されるようにする。
                エンジン: 変更なし（UIのみの改善）。
            Step 23-6-6: 曜日別担当人数設定UIの実装
                目的: 「平日は1人、土日は2人」のように、曜日ごとに必要な担当者数を設定できるようにする。
                UI: 「基本設定」タブの「1日あたりの人数」設定を拡張し、月～日の各曜日と「祝日」に対して個別に人数を設定できるUI（スピンボックスの列など）を作成する。
                エンジン: エンジンはすでに曜日別人数の辞書を受け取れる設計になっているため、UIで設定された値をその形式に変換して渡すロジックを実装する。
            Step 23-6-7 : ルール優先順位の整理と実装
                目的: ルールが衝突した際の挙動を明確に定義し、実装する。
                タスク:
                    エンジン修正: 「担当者不要日」がすべての固定シフトに優先するロジックを実装する。
                    UI改善: 「担当者不要日」に設定された日付は、月限定固定シフトのカレンダーで選択不可にする。
            Step 23-6-8 : 祝日のルール適用選択機能
                目的: 祝日に限って、曜日ベースのルールを無視できるようにする。
                UI: 「基本設定」に「祝日のルール適用」の選択肢（ラジオボタンなど）を追加する。
                エンジン修正: エンジンがこの設定を読み取り、祝日の場合にルールベースの不可日・固定日を無視するロジックを追加する
            step 24-6-9 : 複数担当日の色分け改善 - インジケーター方式
                目的: シフトプレビューカレンダーにおいて、担当者が複数いる場合に、担当者名の横にそれぞれの色がついたインジケーター（小さな円）を描画する。
    step 24: 方向性転換　制約プログラミング(constraint programming-CP)導入
        step 24.5: スタッフの稼働/非稼働(ON/OFF)機能
    step 25:未実装要素の実装
        step 25-1: 先月末の担当者との間隔考慮 (旧Step 17)
            現状: 現在のソルバーは、シフトを生成する月の中だけで勤務間隔を考慮しています。例えば、前月の最終日に勤務したスタッフが、当月の1日や2日に割り当てられてしまい、min_intervalルールを破ってしまう可能性があります。
            必要な実装:
                UI側（generation_tab.py）で、前月のシフト履歴（特に最終数日間の担当者情報）を読み込む機能。
                ShiftScheduler.solveに、last_month_end_stateのような引数を追加で渡し、スタッフごとの「最後に勤務した日」の初期値を設定する。
                _add_hard_constraints内で、d=0（月の1日目）から始まるループで、この前月の最終勤務日からの日数を考慮して制約を追加する。
        step 25-2: 月またぎの連勤日数考慮
            現状: 上記の間隔考慮と同様に、連勤日数も月内でリセットされています。前月末から連続で勤務している場合、当月初の連勤日数が正しくカウントされません。
            必要な実装:
                上記1と同様に、前月の連勤状態を引き継ぐ仕組みが必要です。last_month_end_stateに、最終勤務日だけでなく「その時点での連勤日数」も含めると良いでしょう。
                _add_hard_constraints内の最大連勤日数の制約ロジックが、この初期値を利用するように修正が必要です。
        step 25-3: 「何人から何人」という柔軟な人数設定 (旧ロードマップの未実装要件)
            現状: 1日の担当人数は「N人」という固定値です。
            必要な実装:
                UI側（general_settings_tab.py）で、各曜日の人数設定を「最低N人、最大M人」のように範囲で指定できるように変更。
                _add_hard_constraints内で、model.Add(sum(...) == needed) を model.Add(min_needed <= sum(...) <= max_needed) のような範囲制約（AddLinearConstraintまたはAddの範囲指定）に変更。
        step 25-4 :特定曜日の連続担当回避オプション

    Step 26: 印刷用カレンダーデザイン機能
        目的: プレビューしたカレンダーを、要件定義書にあった3段組（日付、名前、備考）のような、よりリッチなレイアウトで印刷できるようにする。
        タスク: QPrintDialog と QPainter を使い、印刷プレビューと実際の印刷機能を実装する。→エクセル出力し、印刷はエクセルで。
        出力形式の追加: Excelに加えてPDF出力もサポートする。
        デザイン選択の完全な自由化: シフトの人数に関わらず、ユーザーは常に**「グリッド形式」と「タイムラインリスト形式」**のどちらでも出力形式を選択できるようにする。
        履歴保存の分離: ファイル出力と履歴（history）の保存は、ユーザーが明確に区別して実行できるようにする。
    Step 26.5: 高度な担当分散機能の実装
        目的: 特定の曜日（公平性対象）の担当が、短期・長期にわたって同じスタッフに偏るのを防ぎ、より公平で質の高いシフトを実現する。
        UI: 「基本設定」タブに「同じ曜日の担当をできるだけ分散させる」チェックボックスを追加する。
        エンジン:
            このオプションが有効な場合、CP-SATソルバーにソフト制約として新しいペナルティを追加する。
            ペナルティは**「累積・減衰モデル」**を採用する。
                初期ポイント: 過去90日間のカテゴリ別担当回数 × 30
                新規担当ペナルティ: +60
                時間減衰: 1日経過するごとに -1
            ソルバーは、シフト全体の合計ペナルティを最小化する解を探索する。
            SettingsManagerとShiftSchedulerに、このオプションを処理するためのロジックを組み込む。
    step 26.6: step 25-4 :特定曜日の連続担当回避オプションの削除
    Step 27: アプリケーション化（パッケージング）
        目的: PythonがインストールされていないPCでもダブルクリックで実行できる、配布可能なファイルを作成する。
        タスク: PyInstallerを使い、.exe ファイル（Windowsの場合）または .app ファイル（Macの場合）を生成する。
    Step 28: ドキュメントと最終調整
        目的: アプリケーションの完成度を最終的に高める。
        タスク:
        簡単な使い方を説明するヘルプ機能やREADMEファイルを作成する。
        アイコンを設定する。
        全体的なバグチェックと微調整を行う。